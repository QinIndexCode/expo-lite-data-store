# Expo LiteDBStore 架构设计文档

// 创建于: 2025-11-28
// 最后修改: 2026-01-22

## 1. 系统概述

Expo Lite Data Store 是一个基于 Expo 文件系统的轻量级本地数据库解决方案，支持单文件和分片存储模式，提供了完整的 CRUD 操作、事务支持、缓存机制、索引功能、API 路由和数据加密等功能。

## 2. 系统架构

### 2.1 分层架构

Expo Lite Data Store 采用分层架构设计，主要分为以下几层：

| 层         | 职责                         | 主要组件                                                        |
| ---------- | ---------------------------- | --------------------------------------------------------------- |
| 接口层     | 对外提供统一的 API 接口      | FileSystemStorageAdapter, EncryptedStorageAdapter, StorageAdapterFactory |
| 数据访问层 | 处理数据的读写操作           | DataReader, DataWriter, QueryEngine                             |
| 缓存层     | 提供缓存机制，提高查询性能   | CacheManager                                                    |
| 索引层     | 提供索引功能，加速数据查询   | IndexManager                                                    |
| 加密层     | 提供数据加密和密钥管理       | EncryptedStorageAdapter                                         |
| 存储层     | 处理数据的物理存储           | ChunkedFileHandler, SingleFileHandler                           |
| 元数据层   | 管理数据库的元数据           | MetadataManager                                                 |
| 工具层     | 提供通用工具函数             | FileOperationManager                                            |
| 监控层     | 监控系统性能                 | PerformanceMonitor                                              |

### 2.2 核心模块关系

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       Interface Layer                                   │
├─────────────────────────────────┬───────────────────────────────────────┤
│  FileSystemStorageAdapter       │    EncryptedStorageAdapter            │
└─────────────────────────────────┴───────────────────────────────────────┘
                    │                    │                    │
                    ▼                    ▼                    ▼
┌─────────────────────────┐  ┌─────────────────────────┐  ┌─────────────────────────┐
│       DataReader        │  │       DataWriter        │  │   StorageAdapterFactory │
└─────────────────────────┘  └─────────────────────────┘  └─────────────────────────┘
                    │                    │                    │
                    ▼                    ▼                    ▼
┌─────────────────────────┐  ┌─────────────────────────┐  ┌─────────────────────────┐
│      QueryEngine        │  │      IndexManager       │  │    MetadataManager      │
└─────────────────────────┘  └─────────────────────────┘  └─────────────────────────┘
                    │                    │                    │
                    ▼                    ▼                    ▼
┌─────────────────────────┐  ┌─────────────────────────┐  ┌─────────────────────────┐
│       CacheManager      │  │  FileOperationManager   │  │   PerformanceMonitor    │
└─────────────────────────┘  └─────────────────────────┘  └─────────────────────────┘
                    │                    │                    │
                    └────────────────────┼────────────────────┘
                                         ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          Storage Layer                                  │
├─────────────────────────────────┬───────────────────────────────────────┤
│  ChunkedFileHandler             │    SingleFileHandler                  │
└─────────────────────────────────┴───────────────────────────────────────┘
```

## 3. 核心模块设计

### 3.2 接口层模块

#### 3.2.1 FileSystemStorageAdapter

**职责**：作为对外的统一接口，协调各个模块的工作，处理数据的读写操作。

**主要功能**：

- 表管理（创建、删除、列出表）
- 数据读写（插入、更新、删除、查询）
- 事务管理（开始、提交、回滚事务）
- 批量操作
- 模式迁移

#### 3.2.2 EncryptedStorageAdapter

**职责**：提供加密存储功能，保护敏感数据。

**主要功能**：

- 数据加密和解密
- 密钥管理
- 支持不同的加密算法
- 集成到现有存储系统中

#### 3.2.3 StorageAdapterFactory

**职责**：创建和管理存储适配器实例。

**主要功能**：

- 根据配置创建相应的存储适配器
- 支持多种存储模式
- 管理适配器的生命周期

### 3.3 数据访问层模块

#### 3.3.1 DataReader

**职责**：处理数据的读取操作，包括从单文件和分片文件中读取数据，并应用过滤和分页。

**主要功能**：

- 读取表数据
- 应用过滤条件
- 应用分页
- 支持索引查询
- 支持缓存

#### 3.3.2 DataWriter

**职责**：处理数据的写入操作，包括插入、更新、删除和批量操作等。

**主要功能**：

- 写入数据到表中
- 支持单文件和分片存储模式
- 自动创建表（如果不存在）
- 验证写入数据的有效性
- 更新索引
- 更新元数据

#### 3.3.3 QueryEngine

**职责**：处理复杂的查询逻辑，包括过滤、排序、分组等。

**主要功能**：

- 支持复杂查询条件
- 实现多种查询操作符
- 支持排序和分组
- 优化查询性能

### 3.4 加密层模块

#### 3.4.1 加密工具模块

**职责**：提供数据加密和解密功能，基于 @noble/ciphers / @noble/hashes，并在独立打包环境下自动接入 react-native-quick-crypto 原生加速。

**主要功能**：

- **加密算法**：使用 AES-256-CTR + HMAC-SHA512 算法（模拟 GCM 模式）
- **密钥管理**：支持 PBKDF2 密钥派生（动态迭代次数调整）
- **智能密钥缓存**：带 LRU 清理策略的密钥缓存，提高性能
- **批量加密解密**：支持批量处理，提高效率
- **字段级加密**：支持选择性字段加密
- **Expo 环境兼容**：Expo Go 中回退到 JavaScript 实现并使用 expo-crypto 随机数生成
- **原生加速**：独立 APK/IPA 中自动启用 react-native-quick-crypto 的 PBKDF2、随机数与哈希
- **多平台支持**：兼容 React Native、Expo 和 Web 环境

#### 3.4.2 KeyManager

**职责**：管理加密密钥，确保密钥的安全存储和使用。

**主要功能**：

- 密钥生成和管理
- 密钥加密和解密
- 支持多种密钥存储方式（expo-secure-store 或内存）
- 密钥轮换和更新
- 生物识别认证支持

### 3.5 存储层模块

#### 3.5.1 FileHandlerFactory

**职责**：创建和管理文件处理器实例。

**主要功能**：

- 根据存储模式创建相应的文件处理器
- 支持单文件和分片存储模式
- 管理文件处理器的生命周期

#### 3.5.2 FileHandlerBase

**职责**：文件处理器的基类，定义了文件操作的通用接口。

**主要功能**：

- 定义文件操作的通用方法
- 提供文件操作的基础实现
- 支持文件的读写和删除

#### 3.5.3 FileInfoCache

**职责**：缓存文件信息，提高文件操作的性能。

**主要功能**：

- 缓存文件的元数据
- 减少文件系统的访问次数
- 支持缓存的更新和失效

#### 3.5.4 PermissionChecker

**职责**：检查文件操作的权限，确保安全访问。

**主要功能**：

- 检查文件的读写权限
- 处理权限错误
- 支持不同平台的权限模型

### 3.6 监控层模块

#### 3.6.1 CacheMonitor

**职责**：监控缓存的状态和性能。

**主要功能**：

- 监控缓存的命中率
- 统计缓存的使用情况
- 支持缓存事件的监听
- 提供缓存性能报告

#### 3.6.2 PerformanceMonitor

**职责**：监控系统的整体性能。

**主要功能**：

- 监控系统的响应时间
- 统计系统的吞吐量
- 支持性能事件的监听
- 提供性能报告和分析

### 3.7 工具层模块

#### 3.7.1 FileOperationManager

**职责**：管理文件操作，提供文件操作的统一接口。

**主要功能**：

- 统一的文件操作接口
- 支持文件的读写、删除和移动
- 处理文件操作的异常
- 提供文件操作的事务支持

#### 3.7.2 StorageStrategy

**职责**：定义存储策略，决定数据的存储方式。

**主要功能**：

- 定义存储策略的接口
- 支持不同的存储策略实现
- 根据配置选择合适的存储策略

### 3.8 缓存层模块

#### 3.8.1 CacheManager

**职责**：管理缓存数据，实现不同的缓存策略和防护措施。

**主要功能**：

- 支持 LRU 缓存策略
- 提供缓存统计信息
- 支持线程安全的缓存操作
- 支持缓存一致性维护

### 3.9 索引层模块

#### 3.9.1 IndexManager

**职责**：管理索引的创建、查询和更新。

**主要功能**：

- 为数据添加索引
- 从索引中删除数据
- 更新索引
- 使用索引查询数据

### 3.10 元数据层模块

#### 3.10.1 MetadataManager

**职责**：管理数据库的元数据，包括表的结构、索引信息等。

**主要功能**：

- 加载和保存元数据
- 获取单表元数据
- 更新表元数据
- 删除表元数据
- 获取所有表名
- 获取表的记录数

### 3.11 存储层模块

#### 3.11.1 ChunkedFileHandler

**职责**：处理分片存储模式下的文件操作。

**主要功能**：

- 写入数据到分片文件
- 读取分片文件中的数据
- 清除分片文件

#### 3.11.2 SingleFileHandler

**职责**：处理单文件存储模式下的文件操作。

**主要功能**：

- 写入数据到单文件
- 读取单文件中的数据
- 删除单文件

## 4. 数据流

### 4.1 数据写入流程

1. 客户端调用 `write`、`insert` 或 `overwrite` 方法写入数据
2. `FileSystemStorageAdapter` 直接执行写入操作
3. `DataWriter` 验证写入数据的有效性
4. `DataWriter` 自动创建表（如果不存在）
5. `DataWriter` 根据存储模式执行写入操作
   - 单文件模式：直接写入到单文件
   - 分片模式：写入到分片文件
6. `DataWriter` 更新索引
7. `DataWriter` 更新元数据
8. 返回写入结果

### 4.2 数据读取流程

1. 客户端调用 `read`、`findOne` 或 `findMany` 方法读取数据
2. `FileSystemStorageAdapter` 调用 `DataReader` 读取数据
3. `DataReader` 检查是否需要绕过缓存
   - 如果不需要绕过缓存，尝试从缓存中获取数据
   - 如果缓存命中，直接返回数据
4. `DataReader` 检查是否可以使用索引
   - 如果可以使用索引，使用索引查询数据
   - 如果不能使用索引，读取所有数据并应用过滤条件
5. `DataReader` 应用排序和分页
6. `DataReader` 将结果存入缓存（如果不是高危数据）
7. 返回读取结果

### 4.3 事务处理流程

1. 客户端调用 `beginTransaction` 方法开始事务
2. 客户端执行一系列数据操作（写入、删除等）
3. 客户端调用 `commit` 方法提交事务
4. 或者客户端调用 `rollback` 方法回滚事务

## 5. 性能优化

### 5.1 缓存机制

- 使用 LRU 缓存策略，提高查询性能
- 支持缓存统计信息，便于监控缓存性能

### 5.2 索引优化

- 为数据添加索引，加速查询
- 使用索引查询数据，减少全表扫描

### 5.3 分片存储

- 支持分片存储模式，减少内存占用
- 自动处理 >5MB 文件，规避 RN FS 限制

### 5.4 并发控制

- 支持最大并发操作数限制，根据设备性能调整
- 实现操作队列，管理并发操作

## 6. 安全性设计

### 6.1 数据加密

- 支持 AES-CTR 加密，保护敏感数据
- 高危数据直接写入存储，不经过缓存
- 使用 PBKDF2 密钥派生，默认 120,000 次迭代（移动设备优化）
- 支持字段级加密和整表加密
- 支持可选生物识别认证

### 6.2 数据验证

- 验证写入数据的有效性
- 检查字段类型和值的合法性
- 防止注入攻击

### 6.3 事务支持

- 提供事务支持，确保数据一致性
- 支持事务回滚，防止数据损坏

## 7. 扩展性设计

### 7.1 模块化设计

- 采用模块化设计，便于扩展和维护
- 模块间通过接口通信，降低耦合度
- 支持替换和扩展单个模块

### 7.2 插件机制

- 支持插件机制，便于扩展功能
- 支持自定义存储适配器
- 支持自定义缓存策略

### 7.3 配置化设计

- 支持配置化设计，便于调整系统参数
- 支持动态更新配置
- 支持不同环境的配置

## 8. 部署和维护

### 8.1 部署

- 支持 Expo 应用部署
- 支持 React Native 应用部署
- 支持 Web 应用部署

### 8.2 维护

- 提供元数据备份和恢复功能
- 支持日志记录，便于调试和监控
- 提供性能监控指标

## 9. 总结

Expo LiteDBStore 是一个设计良好的本地数据库解决方案，具有清晰的模块化设计、良好的性能优化和较高的代码可维护性。通过采用分层架构、缓存机制、索引优化、分片存储等技术，它能够提供高效、可靠的数据存储服务，适用于各种规模的应用程序。
