# Expo LiteDBStore 架构设计文档

## 1. 系统概述

Expo LiteDBStore 是一个基于 Expo 文件系统的轻量级本地数据库解决方案，支持单文件和分片存储模式，提供了完整的 CRUD 操作、事务支持、缓存机制和索引功能。

## 2. 系统架构

### 2.1 分层架构

Expo LiteDBStore 采用分层架构设计，主要分为以下几层：

| 层         | 职责                         | 主要组件                                                        |
| ---------- | ---------------------------- | --------------------------------------------------------------- |
| 接口层     | 对外提供统一的 API 接口      | FileSystemStorageAdapter                                        |
| 数据访问层 | 处理数据的读写操作           | DataReader, DataWriter                                          |
| 缓存层     | 提供缓存机制，提高查询性能   | CacheManager, CacheController, CacheService                     |
| 索引层     | 提供索引功能，加速数据查询   | IndexManager                                                    |
| 存储层     | 处理数据的物理存储           | FileSystemStorageAdapter, ChunkedFileHandler, SingleFileHandler |
| 元数据层   | 管理数据库的元数据           | MetadataManager                                                 |
| 事务层     | 提供事务支持，确保数据一致性 | TransactionService                                              |
| 任务队列层 | 异步处理批量操作             | StorageTaskProcessor, taskQueue                                 |
| 同步层     | 自动同步缓存中的脏数据       | AutoSyncService                                                 |

### 2.2 核心模块关系

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           FileSystemStorageAdapter                     │
└─────────────────────────────────────────────────────────────────────────┘
                    │                    │                    │
                    ▼                    ▼                    ▼
┌─────────────────────────┐  ┌─────────────────────────┐  ┌─────────────────────────┐
│       DataReader        │  │       DataWriter        │  │   TransactionService    │
└─────────────────────────┘  └─────────────────────────┘  └─────────────────────────┘
                    │                    │                    │
                    └────────────────────┼────────────────────┘
                                         ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           StorageTaskProcessor                         │
└─────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                             taskQueue                                  │
└─────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────┐  ┌─────────────────────────┐  ┌─────────────────────────┐
│       CacheManager      │  │       IndexManager      │  │    MetadataManager      │
└─────────────────────────┘  └─────────────────────────┘  └─────────────────────────┘
                    │                    │                    │
                    ▼                    ▼                    ▼
┌─────────────────────────┐  ┌─────────────────────────┐  ┌─────────────────────────┐
│       CacheService      │  │    FileOperationManager │  │                         │
└─────────────────────────┘  └─────────────────────────┘  └─────────────────────────┘
                    │                    │                    │
                    ▼                    ▼                    ▼
┌─────────────────────────┐  ┌─────────────────────────┐  ┌─────────────────────────┐
│     AutoSyncService     │  │   ChunkedFileHandler    │  │   SingleFileHandler     │
└─────────────────────────┘  └─────────────────────────┘  └─────────────────────────┘
```

## 3. 核心模块设计

### 3.1 FileSystemStorageAdapter

**职责**：作为对外的统一接口，协调各个模块的工作，处理数据的读写操作。

**主要功能**：

- 表管理（创建、删除、列出表）
- 数据读写（插入、更新、删除、查询）
- 事务管理（开始、提交、回滚事务）
- 批量操作
- 模式迁移

### 3.2 DataReader

**职责**：处理数据的读取操作，包括从单文件和分片文件中读取数据，并应用过滤和分页。

**主要功能**：

- 读取表数据
- 应用过滤条件
- 应用分页
- 支持索引查询
- 支持缓存

### 3.3 DataWriter

**职责**：处理数据的写入操作，包括插入、更新、删除和批量操作等。

**主要功能**：

- 写入数据到表中
- 支持单文件和分片存储模式
- 自动创建表（如果不存在）
- 验证写入数据的有效性
- 更新索引
- 更新元数据

### 3.4 CacheManager

**职责**：管理缓存数据，实现不同的缓存策略和防护措施。

**主要功能**：

- 支持 LRU/LFU 缓存策略
- 实现缓存穿透、击穿、雪崩防护
- 提供缓存统计信息
- 支持线程安全的缓存操作
- 支持缓存一致性维护

### 3.5 CacheController

**职责**：管理缓存的一致性，确保缓存与存储数据的一致性。

**主要功能**：

- 清除与特定表相关的缓存
- 清除特定查询的缓存
- 记录缓存键
- 提供缓存事件系统

### 3.6 CacheService

**职责**：提供统一的缓存操作接口，封装了 CacheManager 的功能，管理数据缓存。

**主要功能**：

- 设置缓存
- 获取缓存
- 删除缓存
- 清空缓存
- 标记缓存项为脏数据
- 批量标记缓存项为干净数据
- 获取所有脏数据
- 记录与表相关的缓存键
- 清除与特定表相关的所有缓存

### 3.7 IndexManager

**职责**：管理索引的创建、查询和更新。

**主要功能**：

- 创建普通索引和唯一索引
- 删除索引
- 为数据添加索引
- 从索引中删除数据
- 更新索引
- 使用索引查询数据

### 3.8 MetadataManager

**职责**：管理数据库的元数据，包括表的结构、索引信息等。

**主要功能**：

- 加载和保存元数据
- 获取单表元数据
- 更新表元数据
- 删除表元数据
- 获取所有表名
- 获取表的记录数

### 3.9 TransactionService

**职责**：提供事务支持，确保数据一致性。

**主要功能**：

- 开始事务
- 提交事务
- 回滚事务
- 保存数据快照
- 管理事务操作队列

### 3.10 StorageTaskProcessor

**职责**：处理异步任务，包括批量操作、模式迁移等。

**主要功能**：

- 处理批量写入操作
- 处理模式迁移操作
- 异步执行任务
- 提供任务回调

### 3.11 ChunkedFileHandler

**职责**：处理分片存储模式下的文件操作。

**主要功能**：

- 写入数据到分片文件
- 读取分片文件中的数据
- 清除分片文件
- 支持并行读取分片文件

### 3.12 SingleFileHandler

**职责**：处理单文件存储模式下的文件操作。

**主要功能**：

- 写入数据到单文件
- 读取单文件中的数据
- 删除单文件

### 3.13 AutoSyncService

**职责**：定期将缓存中的脏数据同步到磁盘，确保数据的持久化。

**主要功能**：

- 自动同步脏数据到磁盘
- 支持配置同步间隔和批量大小
- 提供重试机制，确保数据写入成功
- 支持事件监听，通知同步状态
- 提供同步统计信息
- 支持手动触发同步
- 支持停止和启动同步服务

## 4. 数据流

### 4.1 数据写入流程

1. 客户端调用 `write` 方法写入数据
2. `FileSystemStorageAdapter` 检查是否在事务中
   - 如果在事务中，将操作添加到事务队列
   - 如果不在事务中，直接执行写入操作
3. `DataWriter` 验证写入数据的有效性
4. `DataWriter` 自动创建表（如果不存在）
5. `DataWriter` 根据存储模式执行写入操作
   - 单文件模式：直接写入到单文件
   - 分片模式：写入到分片文件
6. `DataWriter` 更新索引
7. `DataWriter` 更新元数据
8. `DataWriter` 清除相关缓存
9. 返回写入结果

### 4.2 数据读取流程

1. 客户端调用 `read` 方法读取数据
2. `FileSystemStorageAdapter` 调用 `DataReader` 读取数据
3. `DataReader` 检查是否需要绕过缓存
   - 如果不需要绕过缓存，尝试从缓存中获取数据
   - 如果缓存命中，直接返回数据
4. `DataReader` 检查是否可以使用索引
   - 如果可以使用索引，使用索引查询数据
   - 如果不能使用索引，读取所有数据并应用过滤条件
5. `DataReader` 应用分页
6. `DataReader` 将结果存入缓存（如果不是高危数据）
7. 返回读取结果

### 4.3 事务处理流程

1. 客户端调用 `beginTransaction` 方法开始事务
2. `TransactionService` 开始事务
3. 客户端执行一系列数据操作（写入、删除等）
   - 这些操作会被添加到事务队列，而不是立即执行
4. 客户端调用 `commit` 方法提交事务
   - `TransactionService` 执行事务队列中的所有操作
   - 如果所有操作成功，事务提交
   - 如果任何操作失败，事务回滚
5. 或者客户端调用 `rollback` 方法回滚事务
   - `TransactionService` 恢复数据快照

### 4.4 自动同步流程

1. `AutoSyncService` 定期检查缓存中的脏数据
2. 当脏数据数量达到阈值或到达指定时间间隔时，触发同步
3. `AutoSyncService` 获取所有脏数据
4. 将脏数据按表名分组
5. 按配置的批量大小处理脏数据
6. 对每个批次执行以下操作：
   - 获取表的写锁
   - 执行批量写入操作
   - 更新索引
   - 更新元数据
   - 批量标记脏数据为干净数据
   - 释放表的写锁
7. 更新同步统计信息
8. 触发同步完成事件

## 5. 性能优化

### 5.1 缓存机制

- 使用 LRU/LFU 缓存策略，提高查询性能
- 实现缓存穿透、击穿、雪崩防护
- 支持缓存统计信息，便于监控缓存性能

### 5.2 索引优化

- 支持普通索引和唯一索引
- 自动为查询选择合适的索引
- 支持多字段索引

### 5.3 分片存储

- 支持分片存储模式，减少内存占用
- 实现并行读取分片文件，提高读取效率
- 支持按需读取分片，减少不必要的 I/O 操作

### 5.4 异步操作

- 使用任务队列异步处理批量操作
- 异步执行事务提交和回滚
- 异步加载元数据，不阻塞启动

## 6. 安全性设计

### 6.1 数据加密

- 支持数据加密，保护敏感数据
- 高危数据直接写入存储，不经过缓存

### 6.2 数据验证

- 验证写入数据的有效性
- 检查字段类型和值的合法性
- 防止注入攻击

### 6.3 事务支持

- 提供事务支持，确保数据一致性
- 支持事务回滚，防止数据损坏

## 7. 扩展性设计

### 7.1 模块化设计

- 采用模块化设计，便于扩展和维护
- 模块间通过接口通信，降低耦合度
- 支持替换和扩展单个模块

### 7.2 插件机制

- 支持插件机制，便于扩展功能
- 支持自定义存储适配器
- 支持自定义缓存策略

### 7.3 配置化设计

- 支持配置化设计，便于调整系统参数
- 支持动态更新配置
- 支持不同环境的配置

## 8. 部署和维护

### 8.1 部署

- 支持 Expo 应用部署
- 支持 React Native 应用部署
- 支持 Web 应用部署

### 8.2 维护

- 提供元数据备份和恢复功能
- 支持日志记录，便于调试和监控
- 提供性能监控指标

## 9. 总结

Expo LiteDBStore 是一个设计良好的本地数据库解决方案，具有清晰的模块化设计、良好的性能优化和较高的代码可维护性。通过采用分层架构、缓存机制、索引优化、分片存储等技术，它能够提供高效、可靠的数据存储服务，适用于各种规模的应用程序。
